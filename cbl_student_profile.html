<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>INSPINIA | Reflection Box</title>

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="font-awesome/css/font-awesome.css" rel="stylesheet">
    <link href="css/plugins/iCheck/custom.css" rel="stylesheet">
    <link href="css/animate.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">

    <style type="text/css">
        #page-wrapper {
            margin: 0;
        }

        .reflections-items-body {
            padding: 0;
        }

        .social-avatar {
            padding: 0;
            padding-bottom: 10px;
        }
    </style>
</head>

<body>

    <div id="wrapper">
        <div id="page-wrapper" class="gray-bg">
            <div class="row border-bottom">
                <nav class="navbar navbar-static-top white-bg" role="navigation" style="margin-bottom: 0">
                    <ul class="nav navbar-top-links navbar-right">
                        <li>
                            <span class="m-r-sm text-muted welcome-message">Bepid Recife 2016 Sprint #0</span>
                        </li>
                        <li>
                            <a data-toggle="dropdown" class="dropdown-toggle" href="#" aria-expanded="false">
                             </span> <span class="text-muted text-xs block"><span class="user-name"></span> <b class="caret"></b></span> </span> 
                            </a>
                            <ul class="dropdown-menu animated fadeInRight m-t-xs">
                                <!-- <li><a href="profile.html">Profile</a></li> -->
                                <!-- <li><a href="contacts.html">Contacts</a></li> -->
                                <!-- <li><a href="mailbox.html">Mailbox</a></li> -->
                                <li class="divider"></li>
                                <li><a id="menu-logout" href="cbl_login_two_columns.html">Logout</a></li>
                            </ul>                            
                        </li>
                    </ul>
                </nav>
            </div>

        <div class="wrapper wrapper-content">
            <div class="row animated fadeInRight">
                <div class="col-md-4">
                    <div class="ibox float-e-margins">
                        <div class="ibox-title">
                            <h5>Profile Detail</h5>
                        </div>
                        <div>
                            <div class="ibox-content no-padding border-left-right">
                                <img alt="image" class="img-responsive" src="img/profile_big.jpg">
                            </div>
                            <div class="ibox-content profile-content">
                                <h4><strong>Monica Smith</strong></h4>
                                <p><i class="fa fa-map-marker"></i> Riviera State 32/106</p>
                                <h5>
                                    About me
                                </h5>
                                <p>
                                    Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitat.
                                </p>
                                <div class="row m-t-lg">
                                    <div class="col-md-4">
                                        <span class="bar">5,3,9,6,5,9,7,3,5,2</span>
                                        <h5><strong>169</strong> Posts</h5>
                                    </div>
                                    <div class="col-md-4">
                                        <span class="line">5,3,9,6,5,9,7,3,5,2</span>
                                        <h5><strong>28</strong> Following</h5>
                                    </div>
                                    <div class="col-md-4">
                                        <span class="bar">5,3,2,-1,-3,-2,2,3,5,2</span>
                                        <h5><strong>240</strong> Followers</h5>
                                    </div>
                                </div>
                                <div class="user-button">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <button type="button" class="btn btn-primary btn-sm btn-block"><i class="fa fa-envelope"></i> Send Message</button>
                                        </div>
                                        <div class="col-md-6">
                                            <button type="button" class="btn btn-default btn-sm btn-block"><i class="fa fa-coffee"></i> Buy a coffee</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="ibox float-e-margins">
                        <div class="ibox-title">
                            <h5>Activites</h5>
                            <div class="ibox-tools">
                                <a class="collapse-link">
                                    <i class="fa fa-chevron-up"></i>
                                </a>
                                <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                                    <i class="fa fa-wrench"></i>
                                </a>
                                <ul class="dropdown-menu dropdown-user">
                                    <li><a href="#">Config option 1</a>
                                    </li>
                                    <li><a href="#">Config option 2</a>
                                    </li>
                                </ul>
                                <a class="close-link">
                                    <i class="fa fa-times"></i>
                                </a>
                            </div>
                        </div>
                        <div class="ibox-content">

                            <div>
                                <div class="feed-activity-list">

                                    <div class="feed-element">
                                        <a href="#" class="pull-left">
                                            <img alt="image" class="img-circle" src="img/a1.jpg">
                                        </a>
                                        <div class="media-body ">
                                            <small class="pull-right text-navy">1m ago</small>
                                            <strong>Sandra Momot</strong> started following <strong>Monica Smith</strong>. <br>
                                            <small class="text-muted">Today 4:21 pm - 12.06.2014</small>
                                            <div class="actions">
                                                <a class="btn btn-xs btn-white"><i class="fa fa-thumbs-up"></i> Like </a>
                                                <a class="btn btn-xs btn-danger"><i class="fa fa-heart"></i> Love</a>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="feed-element">
                                        <a href="#" class="pull-left">
                                            <img alt="image" class="img-circle" src="img/profile.jpg">
                                        </a>
                                        <div class="media-body ">
                                            <small class="pull-right">5m ago</small>
                                            <strong>Monica Smith</strong> posted a new blog. <br>
                                            <small class="text-muted">Today 5:60 pm - 12.06.2014</small>

                                        </div>
                                    </div>

                                    <div class="feed-element">
                                        <a href="#" class="pull-left">
                                            <img alt="image" class="img-circle" src="img/a2.jpg">
                                        </a>
                                        <div class="media-body ">
                                            <small class="pull-right">2h ago</small>
                                            <strong>Mark Johnson</strong> posted message on <strong>Monica Smith</strong> site. <br>
                                            <small class="text-muted">Today 2:10 pm - 12.06.2014</small>
                                            <div class="well">
                                                Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s.
                                                Over the years, sometimes by accident, sometimes on purpose (injected humour and the like).
                                            </div>
                                            <div class="pull-right">
                                                <a class="btn btn-xs btn-white"><i class="fa fa-thumbs-up"></i> Like </a>
                                                <a class="btn btn-xs btn-white"><i class="fa fa-heart"></i> Love</a>
                                                <a class="btn btn-xs btn-primary"><i class="fa fa-pencil"></i> Message</a>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="feed-element">
                                        <a href="#" class="pull-left">
                                            <img alt="image" class="img-circle" src="img/a3.jpg">
                                        </a>
                                        <div class="media-body ">
                                            <small class="pull-right">2h ago</small>
                                            <strong>Janet Rosowski</strong> add 1 photo on <strong>Monica Smith</strong>. <br>
                                            <small class="text-muted">2 days ago at 8:30am</small>
                                            <div class="photos">
                                                <a target="_blank" href="http://24.media.tumblr.com/20a9c501846f50c1271210639987000f/tumblr_n4vje69pJm1st5lhmo1_1280.jpg"> <img alt="image" class="feed-photo" src="img/p1.jpg"></a>
                                                <a target="_blank" href="http://37.media.tumblr.com/9afe602b3e624aff6681b0b51f5a062b/tumblr_n4ef69szs71st5lhmo1_1280.jpg"> <img alt="image" class="feed-photo" src="img/p3.jpg"></a>
                                                </div>
                                        </div>
                                    </div>
                                    <div class="feed-element">
                                        <a href="#" class="pull-left">
                                            <img alt="image" class="img-circle" src="img/a4.jpg">
                                        </a>
                                        <div class="media-body ">
                                            <small class="pull-right text-navy">5h ago</small>
                                            <strong>Chris Johnatan Overtunk</strong> started following <strong>Monica Smith</strong>. <br>
                                            <small class="text-muted">Yesterday 1:21 pm - 11.06.2014</small>
                                            <div class="actions">
                                                <a class="btn btn-xs btn-white"><i class="fa fa-thumbs-up"></i> Like </a>
                                                <a class="btn btn-xs btn-white"><i class="fa fa-heart"></i> Love</a>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="feed-element">
                                        <a href="#" class="pull-left">
                                            <img alt="image" class="img-circle" src="img/a5.jpg">
                                        </a>
                                        <div class="media-body ">
                                            <small class="pull-right">2h ago</small>
                                            <strong>Kim Smith</strong> posted message on <strong>Monica Smith</strong> site. <br>
                                            <small class="text-muted">Yesterday 5:20 pm - 12.06.2014</small>
                                            <div class="well">
                                                Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s.
                                                Over the years, sometimes by accident, sometimes on purpose (injected humour and the like).
                                            </div>
                                            <div class="pull-right">
                                                <a class="btn btn-xs btn-white"><i class="fa fa-thumbs-up"></i> Like </a>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="feed-element">
                                        <a href="#" class="pull-left">
                                            <img alt="image" class="img-circle" src="img/profile.jpg">
                                        </a>
                                        <div class="media-body ">
                                            <small class="pull-right">23h ago</small>
                                            <strong>Monica Smith</strong> love <strong>Kim Smith</strong>. <br>
                                            <small class="text-muted">2 days ago at 2:30 am - 11.06.2014</small>
                                        </div>
                                    </div>
                                    <div class="feed-element">
                                        <a href="#" class="pull-left">
                                            <img alt="image" class="img-circle" src="img/a7.jpg">
                                        </a>
                                        <div class="media-body ">
                                            <small class="pull-right">46h ago</small>
                                            <strong>Mike Loreipsum</strong> started following <strong>Monica Smith</strong>. <br>
                                            <small class="text-muted">3 days ago at 7:58 pm - 10.06.2014</small>
                                        </div>
                                    </div>
                                </div>

                                <button class="btn btn-primary btn-block m"><i class="fa fa-arrow-down"></i> Show More</button>

                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>

            <div class="footer">
                <div class="pull-right">10GB of <strong>250GB</strong> Free.</div>
                <div>
                    <strong>Copyright</strong> Example Company &copy; 2014-2015
                </div>
            </div>
        </div>

        <div class="modal inmodal" id="new-teacher-reflection-modal" tabindex="-1" role="dialog" aria-hidden="true" student-reflection-statement-id="" teacher-reflection-statement-id="P34QuDoziO">
            <div class="modal-dialog">
                <div class="modal-content animated">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title">Teacher Reflection</h4>
                        <small class="font-bold">I have learned from these reflections that...</small>
                    </div>
                    <div class="new-reflection-modal-body modal-body">
                    <style type="text/css">
                        .new-reflection-modal-body {
                            padding: 0;
                        }

                        .new-reflection-textarea {
                            width: 100%;
                            padding: 10px;
                            border: none;
                        }
                    </style>
                        <textarea class="new-reflection-textarea" rows="10"placeholder="in this activity..."></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-white" data-dismiss="modal">Close</button>
                        <button id="btn-save-new-teacher-reflection" type="button" class="btn btn-primary">send reflection</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal inmodal" id="new-reflection-statement-modal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content animated">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title">New Reflection</h4>
                        <small class="font-bold">Propose a new reflection to your class</small>
                    </div>
                    <div class="new-reflection-modal-body modal-body">
                    <style type="text/css">
                        .new-reflection-modal-body {
                            padding: 0;
                        }

                        .new-reflection-statement-textarea {
                            width: 100%;
                            padding: 10px;
                            border: none;
                        }
                    </style>
                        <textarea class="new-reflection-statement-textarea" rows="5" placeholder="in this activity..."></textarea>
                    </div>
                    <div class="modal-footer">
                        <div class="progress progress-small">
                            <div style="width: 0%;" class="progress-bar"></div>
                        </div>
                        <button type="button" class="btn btn-white" data-dismiss="modal">Close</button>
                        <button id="btn-save-new-reflection-statement" type="button" class="btn btn-primary">Save reflection</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Mainly scripts -->
    <script src="js/jquery-2.1.1.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/plugins/metisMenu/jquery.metisMenu.js"></script>
    <script src="js/plugins/slimscroll/jquery.slimscroll.min.js"></script>

    <!-- Custom and plugin javascript -->
    <script src="js/inspinia.js"></script>
    <script src="js/plugins/pace/pace.min.js"></script>

    <script type="text/javascript" src="js/underscore-1.8.3.js"></script>

    <!-- Peity -->
    <script src="js/plugins/peity/jquery.peity.min.js"></script>

    <!-- Peity -->
    <script src="js/demo/peity-demo.js"></script>

    <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.2.18.min.js"></script>
    <script type="text/javascript">
        Parse.initialize("YALt9tjcUpW61Hz5aIPYbehm9uCgh5NXXRVM18T6", "5wwhJ6hfqu8cG4s6jMKMQWrmImiQKDTE9trvgL6x");
    </script>

    <script type="text/javascript">
        var totalNumDoneStudentsReflections = 0;
        var totalStudentsReflections = 0;
        var totalTeachersReflections = 0;
        var totalReflectionStatements = 0;

        var $reflectionStatementRef = $('.reflection-row').detach();
        var $reflectionsPerStatementRef = $('.reflections-per-statement-list').detach();

        $studentPendingReflectionsRowRef = $('.student-pending-reflections-row').detach();
        $teacherReflectionItemRef = $('.teacher-reflection-item').detach();

        function displayReflectionStatementsList() {
            $('.reflections-list').addClass('hide');
            $('.reflections-statements-list').removeClass('hide');
        }

        function displayStudentsReflectionsLists() {
            $('.reflections-list').addClass('hide');
            $('.reflections-per-statement-list').removeClass('hide');
        }

        function displayPendingReflectionsList() {
            $('.reflections-list').addClass('hide');
            $('.pending-reflections-list').removeClass('hide');

            $('.students-pending-reflections-table-body').empty();

            studentsPendencies = {};
            _.each(students, function(student) {
                studentsPendencies[student.id] = [];
            })

            var Reflection = Parse.Object.extend('Reflection');
            var reflectionQuery = new Parse.Query(Reflection);
            reflectionQuery.equalTo('isDone', false);
            reflectionQuery.include('author');
            reflectionQuery.find().then(function(reflections) {
                _.each(reflections, function(reflection) {
                    studentsPendencies[reflection.get('author').id].push(reflection);
                })

                _.each(students, function(student) {
                    if (studentsPendencies[student.id].length > 0) {
                        $studentPendingReflectionsRow = $studentPendingReflectionsRowRef.clone();
                        $studentPendingReflectionsRow.find('.student-name').text(student.get('name'));
                        $studentPendingReflectionsRow.find('.affiliation-info').text(student.get('affiliation'));
                        $studentPendingReflectionsRow.find('.student-email').text(student.get('email'));
                        $studentPendingReflectionsRow.find('.num-student-pending-reflections').text(studentsPendencies[student.id].length);
                        $studentPendingReflectionsRow.appendTo('.students-pending-reflections-table-body');                            
                    }
                })
            })
        }

        function displayTeachersReflectionsPerStatement(statement) {
            $('.reflections-list').addClass('hide');

            var Reflection = Parse.Object.extend('Reflection');
            var query = new Parse.Query(Reflection);
            query.exists('teacherReflectionStatement');
            query.include('author');
            query.find().then(function(reflections){
                $teacherReflectionItems = $('.teachers-reflections-per-statement-list').find('.teachers-reflections-items-body');
                $teacherReflectionItems.empty();
                $('.num-teachers-reflections').text(reflections.length);
                _.each(reflections, function(reflection) {
                    $teacherReflectionItem = $teacherReflectionItemRef.clone();
                    $teacherReflectionItem.find('.reflection-author').text(reflection.get('author').get('name'));
                    $teacherReflectionItem.find('.reflection-text').text(reflection.get('text'));
                    $teacherReflectionItem.appendTo($teacherReflectionItems);
                })        
                $('.teachers-reflections-per-statement-list').removeClass('hide');                
            });
        }

        function displayReflectionsPerStatement(statement) {
            var $reflectionsPerStatement = $reflectionsPerStatementRef.clone();
            var $studentReflectionItemRef = $reflectionsPerStatement.find('.student-reflection-item').detach();
            // var $teacherReflectionItemRef = $reflectionsPerStatement.find('.teacher-reflection-item').detach();
            $reflectionsPerStatement.find('.reflection-statement').text(statement.get('text'));
            $reflectionsPerStatement.appendTo($('.reflections-panel'));

            $studentsReflectionsItemsBody = $reflectionsPerStatement.find('.students-reflections-items-body');

            $reflectionsPerStatement.attr('student-reflection-statement-id', statement.id);
            $reflectionsPerStatement.attr('id', 'student-reflection-statement-id-' + statement.id);
            var reflections = statement.get('teachersReflections');
            for (var i = 0; i < reflections.length; i++) {
                var $reflectionItem = $teacherReflectionItemRef.clone();
                $reflectionItem.find('.reflection-author').text(reflections[i].get('author').get('name'));
                $reflectionItem.find('.reflection-text').text(reflections[i].get('text'));
                $reflectionItem.attr('id', 'teacher-reflection-item-' + reflections[i].id);

                $reflectionItem.appendTo($studentsReflectionsItemsBody);
            }
            totalTeachersReflections += reflections.length;
            $('.total-teachers-reflections').text(totalTeachersReflections);

            reflections = statement.get('reflections');
            var numDoneReflections = 0;
            $reflectionsPerStatement.find('.total-students-reflections').text(reflections.length);
            var studentsReflectionsDict = {};
            for (var i = 0; i < reflections.length; i++) {
                studentsReflectionsDict[reflections[i].get('author').id] = reflections[i];
            }

            _.each(students, function(student) {
                var reflection = studentsReflectionsDict[student.id];
                var $reflectionItem = $studentReflectionItemRef.clone();
                $reflectionItem.find('.student-affiliation').text(reflection.get('author').get('affiliation'));
                $reflectionAuthor = $reflectionItem.find('.reflection-author');
                $reflectionAuthor.text(reflection.get('author').get('name'));

                var reflectionText = reflection.get('text');
                if (!reflectionText || reflectionText == ' ') {
                    $reflectionItem.addClass('reflection-pending');
                    $reflectionAuthor.removeClass('text-info');
                    $reflectionAuthor.addClass('text-danger');
                    $reflectionItem.find('.reflection-text').text('');
                }else {
                    $reflectionItem.find('.reflection-text').text(reflection.get('text'));
                }

                $reflectionItem.appendTo($studentsReflectionsItemsBody);
                if (reflection.get('isDone')) {
                    numDoneReflections++;
                }
            })
            totalNumDoneStudentsReflections += numDoneReflections;
            totalStudentsReflections += reflections.length; 
            totalPendingReflections = totalStudentsReflections - totalNumDoneStudentsReflections;           
            $reflectionsPerStatement.find('.num-students-reflections').text(numDoneReflections);
            $('.total-statement-students-reflections').text(reflections.length);
            $('.total-students-reflections').text(totalStudentsReflections);
            $('.total-done-students-reflections').text(totalNumDoneStudentsReflections);
            $('.total-pending-reflections').text(totalPendingReflections);  
            $('.reflections-per-statement-list').removeClass('hide');
        }

        function displayReflectionStatements(statements) {
            if (statements.length > 0) {
                $('.num-student-reflections-statements').text(statements.length);
                for (i = 0; i < statements.length; i++) {
                    $reflectionStatement = $reflectionStatementRef.clone();
                    $reflectionStatement.find('a').attr('student-reflection-statement-id', statements[i].id);
                    $reflectionStatement.find('.reflection-statement-text').text(statements[i].get('text'));
                    $reflectionStatement.find('.reflection-author').text(statements[i].get('author').get('name'));
                    $reflectionStatement.attr('reflectionId', statements[i].id);
                    $reflectionStatement.appendTo($('.reflections-box').find('tbody'));
                }

                $('.link-show-reflections-per-statement').click(function() {
                    var reflectionStatementId = $(this).attr('student-reflection-statement-id');
                    $('.reflections-per-statement-list').addClass('hide');
                    $('.reflections-statements-list').addClass('hide');
                    $('.reflections-per-statement-list[student-reflection-statement-id=' + reflectionStatementId + ']').removeClass('hide');
                })

                $('.total-statement-reflections').text(statements.length);

                $('.btn-save-reflection').click(function() {
                    var firstName = $(this).parents('form').find('#inputFirstName').val();
                    var lastName = $(this).parents('form').find('#inputLastName').val();
                    var email = $(this).parents('form').find('#inputEmail').val();
                    var password = "123";
                    var text = $(this).parents('form').find('#inputReflectionText').val();
                    var reflectionStatementId = $(this).parents('.social-feed-box').attr('reflectionId');
                    saveReflection(email, firstName, lastName, text, password, reflectionStatementId).then(function() {
                        updateReflectionStatement(reflectionStatementId);
                    });

                    $(this).parents('form').find('#inputEmail').focus();
                })

                $('.social-feed-box #inputEmail').change(function() {
                    $socialFeedBox = $(this).parents('.social-feed-box');
                    var reflectionStatementId = $(this).parents('.social-feed-box').attr('reflectionId');

                    var email = $(this).val().trim();

                    var userQuery = new Parse.Query(Parse.User);
                    userQuery.equalTo('username', email);
                    userQuery.find().then(function(users) {
                        if (users.length > 0) {
                            var user = users[0];
                            $socialFeedBox.find('#inputFirstName').val(user.get('firstName'));
                            $socialFeedBox.find('#inputLastName').val(user.get('lastName'));
                        }
                        $socialFeedBox.find('.user-exists').removeClass('hide');
                    })
                })
            }
        }

        function saveReflection(email, firstName, lastName, text, password, reflectionId) {
            var user = new Parse.User();

            var userQuery = new Parse.Query(Parse.User);
            userQuery.equalTo('username', email);


            user.set("username", email);
            user.set("password", password);
            user.set("email", email);
            user.set("firstName", firstName);
            user.set("lastName", lastName);

            return userQuery.find().then(function(users) {
                if (users.length > 0) {
                    var usr = users[0];
                    var ReflectionStatement = Parse.Object.extend('ReflectionStatement');
                    var query = new Parse.Query(ReflectionStatement);
                    var reflectionStatement
                    query.get(reflectionId).then(function(statement) {
                        reflectionStatement = statement;

                        var Reflection = Parse.Object.extend("Reflection");
                        var reflectionQuery = new Parse.Query(Reflection);
                        reflectionQuery.equalTo('reflectionStatement', statement);
                        reflectionQuery.equalTo('author', usr);
                        return reflectionQuery.find().then(function(reflections) {
                            if (reflections.length > 0) {
                                // var reflection = new Reflection();
                                var reflection = reflections[0];
                                // reflection.set('author', usr);
                                reflection.set('text', text);
                                // reflection.set('reflectionStatement', reflectionStatement);
                                if (text != '') {
                                    reflection.set('isDone', true);
                                    reflection.set('isAccepted', true);
                                }else {
                                    reflection.set('isDone', false);
                                    reflection.set('isAccepted', false);                            
                                }

                                return reflection.save();
                            }
                        }) 
                    }).then(function(reflect) { 
                        $('#inputFirstName').val('');
                        $('#inputLastName').val('');
                        $('#inputEmail').val('');
                        $('#inputReflectionText').val('');
                        $('.user-exists').addClass('hide');
                        return updateReflectionStatement(reflectionStatement.id);                        
                    })
                }else {
                    user.signUp(null, {
                      success: function(user) {
                        var usr = Parse.User.current();                
                        if (usr) {
                            $('#inputFirstName').val('');
                            $('#inputLastName').val('');
                            $('#inputEmail').val('');
                            $('#inputReflectionText').val('');
                            $('.user-exists').addClass('hide');
                            Parse.User.logOut();

                            var ReflectionStatement = Parse.Object.extend('ReflectionStatement');
                            var query = new Parse.Query(ReflectionStatement);
                            var reflectionStatement
                            query.get(reflectionId).then(function(statement) {
                                reflectionStatement = statement;

                                var Reflection = Parse.Object.extend("Reflection");
                                var reflection = new Reflection();

                                reflection.set('author', usr);
                                reflection.set('text', text);
                                if (text != '') {
                                    reflection.set('isDone', true);
                                    reflection.set('isAccepted', true);
                                }else {
                                    reflection.set('isDone', false);
                                    reflection.set('isAccepted', false);                            
                                }

                                return reflection.save();
                            }).then(function(reflect) { 
                                reflectionStatement.add('reflections', reflect);
                                return reflectionStatement.save();
                            }).then(function(statement) {
                                return updateReflectionStatement(statement.id);
                            })
                        }
                      },
                      error: function(user, error) {
                        alert("Error: " + error.code + " " + error.message);
                      }
                    });                    
                }
            });            
        }
    </script>

    <script type="text/javascript">
        var students = [];
        var teachers = [];
        var currentTeacherReflection;

        $('.reflections-list').addClass('hide');

        $(function() {
            var user = Parse.User.current();
            if (user) {
                $('.user-name').text(user.get('name'));
                var query = new Parse.Query(Parse.User);
                query.ascending('firstName');
                query.limit(100);
                query.find().then(function(users) {
                    _.each(users, function(user) {
                        if (user.get('isStudent')) {
                            students.push(user);
                        }else {
                            teachers.push(user);
                        }
                    })
                    var ReflectionStatement = Parse.Object.extend("ReflectionStatement");
                    var query = new Parse.Query(ReflectionStatement);
                    query.include('author');
                    query.equalTo('isStudent', true);
                    query.descending('createdAt');
                    query.include('reflections.author');
                    query.include('teachersReflections.author');
                    query.find().then(function(statements) {
                        displayReflectionStatements(statements);

                        for (var i = 0; i < statements.length; i++) {
                            displayReflectionsPerStatement(statements[i]);
                        }

                        $('.btn-show-all-reflections').click(function() {
                            $reflectionsPerStatement = $(this).parents('.reflections-per-statement-list');
                            $reflectionsItems = $reflectionsPerStatement.find('.reflection-item');
                            $reflectionsItems.removeClass('hide');
                        })

                        $('.menu-show-students-reflections').click(function() {
                            displayStudentsReflectionsLists();
                        })

                        $('.menu-show-reflections-statements').click(function() {
                            displayReflectionStatementsList();
                        })

                        $('.menu-show-pending-reflections-list').click(function() {
                            displayPendingReflectionsList();
                        })

                        $('.menu-show-teachers-reflections').click(function() {
                            displayTeachersReflectionsPerStatement();
                        })                        

                        $('.btn-show-done-reflections').click(function() {
                            $reflectionsPerStatement = $(this).parents('.reflections-per-statement-list');
                            $reflectionsItems = $reflectionsPerStatement.find('.reflection-item');
                            $teachersReflectionsItems = $reflectionsPerStatement.find('.teacher-reflection-item');
                            $pendingReflectionsItems = $reflectionsPerStatement.find('.reflection-item.reflection-pending');
                            $reflectionsItems.removeClass('hide');
                            $teachersReflectionsItems.addClass('hide');
                            $pendingReflectionsItems.addClass('hide');
                        })            

                        $('.btn-show-teachers-reflections').click(function() {
                            $reflectionsPerStatement = $(this).parents('.reflections-per-statement-list');
                            $reflectionsItems = $reflectionsPerStatement.find('.reflection-item');
                            $teachersReflectionsItems = $reflectionsPerStatement.find('.teacher-reflection-item');
                            $reflectionsItems.addClass('hide');
                            $teachersReflectionsItems.removeClass('hide');
                        })            

                        $('.btn-show-pending-reflections').click(function() {
                            $reflectionsPerStatement = $(this).parents('.reflections-per-statement-list');
                            $reflectionsItems = $reflectionsPerStatement.find('.reflection-item');
                            $pendingReflectionsItems = $reflectionsPerStatement.find('.reflection-item.reflection-pending');
                            $reflectionsItems.addClass('hide');
                            $pendingReflectionsItems.removeClass('hide');
                        })

                        $('.btn-new-teacher-reflection').click(function() {
                            var studentReflectionStatementId = $(this).parents('.reflections-per-statement-list').attr('student-reflection-statement-id');
                            var teacherReflectionStatementId = "P34QuDoziO";

                            $('#new-teacher-reflection-modal').attr('student-reflection-statement-id', studentReflectionStatementId);

                            var teacherReflectionStatement;
                            var studentReflectionStatement;

                            var promises = [];
                            var ReflectionStatement = Parse.Object.extend('ReflectionStatement');
                            var statementQuery = new Parse.Query(ReflectionStatement);

                            promises.push(statementQuery.get(studentReflectionStatementId).then(function(statement) {
                                studentReflectionStatement = statement;
                            }));            
                            promises.push(statementQuery.get(teacherReflectionStatementId).then(function(statement) {
                                teacherReflectionStatement = statement;
                            }));            

                            return Parse.Promise.when(promises).then(function() {
                                var currentUser = Parse.User.current();

                                var Reflection = Parse.Object.extend('Reflection');
                                var reflectionQuery = new Parse.Query(Reflection);
                                reflectionQuery.equalTo('author', currentUser);
                                reflectionQuery.equalTo('reflectionStatement', studentReflectionStatement);
                                reflectionQuery.equalTo('teacherReflectionStatement', teacherReflectionStatement);
                                reflectionQuery.find().then(function(reflections) {
                                    if (reflections.length == 1) {
                                        currentTeacherReflection = reflections[0];
                                        $('.new-reflection-textarea').val(currentTeacherReflection.get('text'));
                                    }else {
                                        currentTeacherReflection = new Reflection();
                                    }
                                })
                            })
                        })

                        // updateReflectionsMenu(statements);
                    })
                })
            }else {
                window.location = "cbl_login_two_columns.html";
            }
        })


        $('#newReflectionModal').on("shown.bs.modal", function() {
            $('.new-reflection-textarea').focus();
        })

        $('#new-teacher-reflection-modal').on("shown.bs.modal", function() {
            $('.new-reflection-textarea').focus();
        })

        $('#btn-save-new-teacher-reflection').click(function() {
            $modal = $(this).parents('#new-teacher-reflection-modal');

            var studentReflectionStatementId = $modal.attr('student-reflection-statement-id');
            var teacherReflectionStatementId = 'P34QuDoziO';

            var ReflectionStatement = Parse.Object.extend('ReflectionStatement');
            var studentReflectionStatement;
            var teacherReflectionStatement;

            var reflectionStatementQuery = new Parse.Query(ReflectionStatement);
            var promises = [];

            promises.push(reflectionStatementQuery.get(studentReflectionStatementId).then(function(statement) {
                studentReflectionStatement = statement;
            }));
            promises.push(reflectionStatementQuery.get(teacherReflectionStatementId).then(function(statement) {
                teacherReflectionStatement = statement;
            }));

            Parse.Promise.when(promises).then(function() {
                var $textarea = $('#new-teacher-reflection-modal').find('.new-reflection-textarea');
                var text = $textarea.val().trim();

                var reflection = currentTeacherReflection;

                reflection.set('author', Parse.User.current());
                reflection.set('isDone', true);
                reflection.set('reflectionStatement', studentReflectionStatement);
                reflection.set('teacherReflectionStatement', teacherReflectionStatement);
                reflection.set('text',text);
                reflection.save().then(function(ref) {
                    studentReflectionStatement.addUnique('teachersReflections', ref);
                    $textarea.val('');
                    $modal.modal('hide');
                    return ref.save().then(function() {
                        // var scroll = $('.reflections-per-statement-list[student-reflection-statement-id=' + studentReflectionStatementId + ']').scrollTop();
                        document.getElementById('student-reflection-statement-id-' + studentReflectionStatementId).scrollIntoView()
                        $('#teacher-reflection-item-' + currentTeacherReflection.id).find('.reflection-text').text(text);
                    });
                });
            })
        })

        $('#btn-save-new-reflection-statement').click(function() {
            var text = $('.new-reflection-statement-textarea').val().trim();

            var reflections = [];
            var ReflectionStatement = Parse.Object.extend('ReflectionStatement');
            var reflectionStatement = new ReflectionStatement();
            reflectionStatement.set('author', Parse.User.current());
            reflectionStatement.set('text', text);
            reflectionStatement.set('reflections', []);
            reflectionStatement.set('teachersReflections', []);
            reflectionStatement.set('isStudent', true);
            reflectionStatement.save().then(function(statement) {
                var promise = Parse.Promise.as();
                var totalReflections = students.length;
                var numSavedEmptyReflections = 0;
                _.each(students, function(student) {
                    var Reflection = Parse.Object.extend('Reflection');
                    var reflection = new Reflection();
                    reflection.set('author', student);
                    reflection.set('isDone', false);
                    reflection.set('reflectionStatement', statement);
                    promise = promise.then(function() {                        
                        return reflection.save().then(function(refl) {
                            numSavedEmptyReflections++;
                            $('.progress-bar').css('width', (numSavedEmptyReflections/totalReflections)*100 + '%');
                            reflections.push(refl);
                        });
                    })
                })
                return promise;
            }).then(function() {
                reflectionStatement.set('reflections', reflections);
                reflectionStatement.save().then(function() {
                    $('#newReflectionModal').modal('hide');
                    location.reload();
                });
            })

        })

        $('#link-logout').click(function() {
            Parse.User.logOut();
        })

        $('#menu-logout').click(function() {
            Parse.User.logOut();
        })
        
    </script>

</body>

</html>
